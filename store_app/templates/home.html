{% extends 'base.html' %}
{% load static %}

{% block content %}


<!-- –í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
<div class="alert alert-info alert-dismissible fade show" role="alert" style="position: fixed; top: 10px; right: 10px; z-index: 9999;">
    <strong>–û—Ç–ª–∞–¥–∫–∞:</strong>
    <span id="debug-status">–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>


<style>
/* –°—Ç–∏–ª—å –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –±—Ä–µ–Ω–¥–∞ */
.brand-title {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 6rem;
    font-weight: 800;
    margin-bottom: 0.5rem;
    padding: 0;
    display: block;
}

/* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –±—Ä–µ–Ω–¥–∞ */
.brand-gradient {
    background: #55759c;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 0 4px 8px rgba(0,0,0,0.2);
    letter-spacing: 2px;
}

/* –°—Ç–∏–ª—å –¥–ª—è –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞ –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º –±—Ä–µ–Ω–¥–∞ */
.brand-subtitle {
    color: #6c757d;
    font-size: 1.5rem;
    font-weight: 300;
    letter-spacing: 3px;
    margin-bottom: 3rem;
}

/* –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã" —Å –±—Ä–µ–Ω–¥–æ–≤—ã–º —Å–∏–Ω–∏–º —Ü–≤–µ—Ç–æ–º */
.btn-primary {
    background-color: #55759c !important;
    border-color: #55759c !important;
    color: white !important;
}

/* –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã" –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
.btn-primary:hover {
    background-color: #466187 !important;
    border-color: #466187 !important;
}

/* –ö–Ω–æ–ø–∫–∞ "–°–±—Ä–æ—Å–∏—Ç—å" —Å –∫–æ–Ω—Ç—É—Ä–Ω—ã–º —Å—Ç–∏–ª–µ–º */
.btn-outline-secondary {
    color: #55759c !important;
    border-color: #55759c !important;
    background-color: transparent !important;
}

/* –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–°–±—Ä–æ—Å–∏—Ç—å" –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
.btn-outline-secondary:hover {
    background-color: #55759c !important;
    color: white !important;
}

/* –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ–π—Ç–∏ –≤ –º–∞–≥–∞–∑–∏–Ω" —Å –±–ª–µ–¥–Ω–æ-—Å–∏—Ä–µ–Ω–µ–≤—ã–º –∞–∫—Ü–µ–Ω—Ç–æ–º */
.btn-success {
    background-color: #9575cd !important;
    border-color: #b39ddb !important;
    color: white !important;
}

/* –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–í –º–∞–≥–∞–∑–∏–Ω" –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
.btn-success:hover {
    background-color: #8B5CF6 !important;
    border-color: #B19CD9 !important;
}

/* –°—Ç–∏–ª—å –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–î–æ—Å—Ç—É–ø–µ–Ω" */
.bg-success {
    background-color: #e8f5e9 !important;
    color: #2e7d32 !important;
    border: 1px solid #c8e6c9 !important;
}

/* –°—Ç–∏–ª—å –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏" */
.bg-danger {
    background-color: #ffebee !important;
    color: #c62828 !important;
    border: 1px solid #ffcdd2 !important;
}

/* –í—ã–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–∞ */
.price-highlight {
    color: #6B8E61 !important;
}

/* –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞ —Å –∞–∫—Ü–µ–Ω—Ç–Ω—ã–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º */
.product-card {
    transition: box-shadow 0.3s ease;
}

/* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–≤–∞—Ä–∞ */
.product-card:hover {
    box-shadow: 0 4px 12px rgba(85, 117, 156, 0.15) !important;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–µ —Å –ø—Ä–∏–∂–∞—Ç–∏–µ–º –∫ –≤–µ—Ä—Ö—É */
.card-body {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    height: 100%;
    padding-top: 1rem;
}

/* –í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∏ –∫–Ω–æ–ø–∫–∞–º–∏ */
.card-body .d-flex.justify-content-between {
    flex-shrink: 0;
    margin-bottom: 1rem;
}

/* –ù–∏–∂–Ω—è—è —á–∞—Å—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –¥–µ—Ç–∞–ª—è–º–∏ —Ç–æ–≤–∞—Ä–∞ */
.card-body .mt-auto {
    margin-top: auto !important;
    flex-shrink: 0;
}

/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–æ–≤–∞—Ä–∞ —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –æ—Ç—Å—Ç—É–ø–æ–º */
.card-title {
    margin-bottom: 0.5rem !important;
}

/* –ë–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π */
.d-flex.flex-column.align-items-end {
    flex-shrink: 0;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç—Ä–æ–∫–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞ */
.row.g-0 {
    align-items: flex-start;
}

/* –ö–æ–ª–æ–Ω–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ–≤–∞—Ä–µ */
.col-md-8 {
    display: flex;
    flex-direction: column;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
.loading-indicator {
    display: none;
    text-align: center;
    padding: 2rem;
}

.loading-spinner {
    width: 3rem;
    height: 3rem;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #55759c;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.end-of-results {
    text-align: center;
    padding: 2rem;
    color: #6c757d;
    font-style: italic;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ —Å –¥–≤—É–º—è –∫–æ–ª–æ–Ω–∫–∞–º–∏ */
.products-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 768px) {
    .products-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .brand-title {
        font-size: 3rem;
    }

    .brand-subtitle {
        font-size: 1.2rem;
    }
}

/* –î–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
@media (max-width: 576px) {
    .products-grid {
        gap: 0.75rem;
    }
}
</style>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-12 text-center">
            <h1 class="brand-title">
                <span class="brand-gradient">Gadgetia</span>
            </h1>
            <p class="brand-subtitle">–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ –≤—Å–µ–≥–¥–∞ –≤ –Ω–∞–ª–∏—á–∏–∏</p>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" action="{% url 'home' %}" id="filter-form">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="city" class="form-label">–ì–æ—Ä–æ–¥</label>
                                <select class="form-select" id="city" name="city">
                                    <option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>
                                    {% for city in cities %}
                                        <option value="{{ city }}" {% if selected_city == city %}selected{% endif %}>{{ city }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="store" class="form-label">–§–∏–ª–∏–∞–ª</label>
                                <select class="form-select" id="store" name="store">
                                    <option value="">–í—Å–µ —Ñ–∏–ª–∏–∞–ª—ã</option>
                                    {% for store in stores %}
                                        <option value="{{ store.id }}" {% if selected_store == store.id|stringformat:"s" %}selected{% endif %}>{{ store.address }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="category" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                                <select class="form-select" id="category" name="category">
                                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                                    {% for category in categories %}
                                        <option value="{{ category.id }}" {% if selected_category == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12 text-center">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-filter me-1"></i>–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                                </button>
                                <a href="{% url 'home' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-redo me-1"></i>–°–±—Ä–æ—Å–∏—Ç—å
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ —Å grid layout -->
    <div class="products-grid" id="products-container">
        {% if products %}
            {% for product in products %}
                <div class="product-item">
                    <div class="card h-100 product-card">
                        <div class="row g-0 h-100">
                            <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ -->
                            <div class="col-md-4">
                                <div class="card-img-container h-100">
                                    {% if product.image %}
                                        <img src="{{ product.image.url }}" class="img-fluid rounded-start h-100 w-100" style="object-fit: cover;" alt="{{ product.name }}">
                                    {% else %}
                                        <div class="text-center py-5 bg-light h-100 d-flex align-items-center justify-content-center">
                                            <i class="fas fa-image fa-3x text-muted"></i>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
                            <div class="col-md-8">
                                <div class="card-body d-flex flex-column h-100">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="flex-grow-1">
                                            <h5 class="card-title">
                                                {{ product.name }}
                                            </h5>
                                        </div>
                                        <div class="d-flex flex-column align-items-end">
                                            {% if user.is_authenticated and user.role == 'CUSTOMER' %}
                                                <button class="btn btn-sm btn-outline-warning favorite-btn mb-2"
                                                        data-product-id="{{ product.id }}"
                                                        id="favorite-btn-{{ product.id }}"
                                                        data-initial-state="{% if product.id in user_favorites %}active{% else %}inactive{% endif %}">
                                                    <i class="{% if product.id in user_favorites %}fas{% else %}far{% endif %} fa-star"></i>
                                                </button>
                                            {% endif %}
                                            <a href="{% url 'product_detail' id=product.id slug=product.slug %}"
                                               class="btn btn-sm btn-outline-primary mb-2"
                                               title="–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ">
                                                <i class="fas fa-info-circle"></i> –î–µ—Ç–∞–ª–∏
                                            </a>
                                            {% if product.external_url %}
                                                <a href="{{ product.external_url }}" target="_blank" class="btn btn-sm btn-success" id="product-link-{{ product.id }}">
                                                    <i class="fas fa-external-link-alt me-1"></i>–ü–µ—Ä–µ–π—Ç–∏ –≤ –º–∞–≥–∞–∑–∏–Ω
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="mt-auto">
                                        <p class="card-text mb-1">
                                            <strong class="fs-4 price-highlight">{{ product.price }} ‚ÇΩ</strong>
                                        </p>
                                        <p class="card-text mb-1">
                                            <span class="badge bg-light text-dark border">
                                                <i class="fas fa-tag me-1"></i>{{ product.category.name }}
                                            </span>
                                        </p>
                                        <p class="card-text mb-1">
                                            <i class="fas fa-map-marker-alt text-primary me-1"></i>
                                            <small>{{ product.store.city }}, {{ product.store.address }}</small>
                                        </p>
                                        <p class="card-text mb-2">
                                            <span class="badge bg-{% if product.available %}success{% else %}danger{% endif %}">
                                                {% if product.available %}
                                                    <i class="fas fa-check me-1"></i>–î–æ—Å—Ç—É–ø–µ–Ω
                                                {% else %}
                                                    <i class="fas fa-times me-1"></i>–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
                                                {% endif %}
                                            </span>
                                        </p>
                                        {% if product.description %}
                                            <p class="card-text">
                                                <small class="text-muted">{{ product.description|truncatechars:120 }}</small>
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="col-12 text-center">
                <div class="alert alert-info py-4">
                    <i class="fas fa-search fa-2x mb-3"></i>
                    <h5>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h5>
                    <p class="mb-0">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</p>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loading-indicator" class="loading-indicator">
        <div class="loading-spinner"></div>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</p>
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∫–æ–Ω—Ü–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
    <div id="end-of-results" class="end-of-results" style="display: none;">
        <p>–í—Å–µ —Ç–æ–≤–∞—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
console.log('–°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω - –Ω–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é');

let currentPage = 1;
let isLoading = false;
let hasMore = true;
let totalLoaded = {{ products|length }};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
function updateDebugInfo(message) {
    console.log('–û—Ç–ª–∞–¥–∫–∞:', message);
    $('#debug-status').text(message);
    console.log('currentPage:', currentPage, 'isLoading:', isLoading, 'hasMore:', hasMore, 'totalLoaded:', totalLoaded);
}

$(document).ready(function() {
    updateDebugInfo('–î–æ–∫—É–º–µ–Ω—Ç –≥–æ—Ç–æ–≤');

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    initializeFavoriteButtons($('.favorite-btn'));
    updateDebugInfo('–ö–Ω–æ–ø–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞
    setupInfiniteScroll();
    updateDebugInfo('–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Å–∫—Ä–æ–ª–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —Å—Ä–∞–∑—É –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    setTimeout(checkIfNeedMoreContent, 1000);
});

function setupInfiniteScroll() {
    console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞...');

    $(window).on('scroll', function() {
        if (isLoading || !hasMore) return;

        const scrollTop = $(window).scrollTop();
        const windowHeight = $(window).height();
        const documentHeight = $(document).height();
        const scrollThreshold = 500;

        console.log('Scroll - Top:', scrollTop, 'Window:', windowHeight, 'Doc:', documentHeight, 'Threshold:', scrollThreshold);

        if (scrollTop + windowHeight >= documentHeight - scrollThreshold) {
            updateDebugInfo('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ø–æ—Ä–æ–≥ —Å–∫—Ä–æ–ª–ª–∞ - –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã');
            loadMoreProducts();
        }
    });
}

function checkIfNeedMoreContent() {
    const docHeight = $(document).height();
    const winHeight = $(window).height();

    console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—Å–æ—Ç—ã - –î–æ–∫—É–º–µ–Ω—Ç:', docHeight, '–û–∫–Ω–æ:', winHeight);

    if (docHeight <= winHeight + 100 && hasMore && !isLoading) {
        updateDebugInfo('–ú–∞–ª–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ - –∑–∞–≥—Ä—É–∂–∞–µ–º –±–æ–ª—å—à–µ');
        loadMoreProducts();
    }
}

function loadMoreProducts() {
    if (isLoading) {
        console.log('–£–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
        return;
    }
    if (!hasMore) {
        console.log('–ë–æ–ª—å—à–µ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤');
        return;
    }

    console.log('–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã:', currentPage + 1);
    updateDebugInfo('–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ' + (currentPage + 1));

    isLoading = true;
    const nextPage = currentPage + 1;

    // –°–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const params = new URLSearchParams(window.location.search);
    params.set('page', nextPage);

    console.log('URL –∑–∞–ø—Ä–æ—Å–∞:', '{% url "home" %}?' + params.toString());

    $.ajax({
        url: '{% url "home" %}?' + params.toString(),
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(data) {
            console.log('AJAX —É—Å–ø–µ—Ö, –ø–æ–ª—É—á–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö:', data.length);
            console.log('–î–∞–Ω–Ω—ã–µ:', data);

            if (data && data.trim()) {
                const $newContent = $(data);
                const $productItems = $newContent.filter('.product-item');

                console.log('–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤:', $productItems.length);

                if ($productItems.length > 0) {
                    $('#products-container').append($productItems);
                    totalLoaded += $productItems.length;
                    currentPage = nextPage;

                    updateDebugInfo('–ó–∞–≥—Ä—É–∂–µ–Ω–æ ' + $productItems.length + ' —Ç–æ–≤–∞—Ä–æ–≤. –í—Å–µ–≥–æ: ' + totalLoaded);
                    console.log('–¢–æ–≤–∞—Ä—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É');

                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
                    initializeFavoriteButtons($productItems.find('.favorite-btn'));

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –µ—â–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å
                    setTimeout(checkIfNeedMoreContent, 500);
                } else {
                    console.log('–ù–µ—Ç –Ω–æ–≤—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ - –∑–∞–≤–µ—Ä—à–∞–µ–º');
                    hasMore = false;
                    $('#end-of-results').show();
                    updateDebugInfo('–í—Å–µ —Ç–æ–≤–∞—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                }
            } else {
                console.log('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç - –∑–∞–≤–µ—Ä—à–∞–µ–º');
                hasMore = false;
                $('#end-of-results').show();
                updateDebugInfo('–í—Å–µ —Ç–æ–≤–∞—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
            }
        },
        error: function(xhr, status, error) {
            console.error('–û—à–∏–±–∫–∞ AJAX:', error);
            console.error('Status:', status);
            console.error('XHR:', xhr);

            hasMore = false;
            $('#end-of-results').show().html('<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error + '</p>');
            updateDebugInfo('–û—à–∏–±–∫–∞: ' + error);
        },
        complete: function() {
            isLoading = false;
            $('#loading-indicator').hide();
            console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        }
    });

    $('#loading-indicator').show();
}

function initializeFavoriteButtons($buttons) {
    $buttons.each(function() {
        const btn = $(this);
        const initialState = btn.data('initial-state');
        const icon = btn.find('i');

        if (initialState === 'active') {
            icon.removeClass('far').addClass('fas');
            btn.addClass('active');
        } else {
            icon.removeClass('fas').addClass('far');
            btn.removeClass('active');
        }
    });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
$(document).on('click', '.favorite-btn', function() {
    const btn = $(this);
    const productId = btn.data('product-id');
    const csrfToken = $('input[name="csrfmiddlewaretoken"]').val() || '{{ csrf_token }}';

    $.ajax({
        url: '{% url "toggle_favorite" %}',
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
        },
        data: {
            'product_id': productId
        },
        success: function(data) {
            if (data.status === 'added') {
                btn.find('i').removeClass('far').addClass('fas');
                btn.data('initial-state', 'active');
                btn.addClass('active');
            } else if (data.status === 'removed') {
                btn.find('i').removeClass('fas').addClass('far');
                btn.data('initial-state', 'inactive');
                btn.removeClass('active');
            }

            if (typeof updateFavoriteCounter === 'function') {
                updateFavoriteCounter(data.count);
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞';
            alert(error);
        }
    });
});

// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
window.forceLoad = function() {
    console.log('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞');
    loadMoreProducts();
};
</script>

<!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
    <button onclick="forceLoad()" class="btn btn-warning btn-lg">
        üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ
    </button>
</div>
{% endblock %}