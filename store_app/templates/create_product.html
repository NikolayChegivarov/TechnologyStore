{% extends 'base.html' %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="h5 mb-0"><i class="fas fa-plus-circle me-2"></i> Создание нового товара</h2>
                        <a href="{% url 'manager_dashboard' %}" class="btn btn-sm btn-light">
                            <i class="fas fa-arrow-left me-1"></i> Назад
                        </a>
                    </div>
                </div>

                <div class="card-body">
                    {% if success_message %}
                    <div class="alert alert-success alert-dismissible fade show mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-check-circle me-2"></i>
                                {{ success_message }}
                            </div>
                            <div>
                                <a href="{% url 'product_detail' id=created_product.id slug=created_product.slug %}"
                                   class="btn btn-success btn-sm ms-3">
                                    <i class="fas fa-eye me-1"></i> Посмотреть товар
                                </a>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate id="product-form">
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                <p class="mb-0">{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <div class="row g-3">
                            <!-- Название товара -->
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="product_name"
                                           name="{{ form.name.name }}"
                                           value="{% if not success_message %}{{ form.name.value|default:'' }}{% endif %}"
                                           required>
                                    <label for="product_name">Название товара *</label>
                                    {% if form.name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.name.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Цена -->
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="number" class="form-control" id="product_price"
                                           name="{{ form.price.name }}"
                                           value="{% if not success_message %}{{ form.price.value|default:'' }}{% endif %}"
                                           step="0.01" min="0" required>
                                    <label for="product_price">Цена *</label>
                                    {% if form.price.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.price.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Категория -->
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select class="form-select" id="product_category"
                                            name="{{ form.category.name }}" required>
                                        {% for value, label in form.category.field.choices %}
                                            <option value="{{ value }}"
                                                {% if not success_message and form.category.value == value %}selected{% endif %}>
                                                {{ label }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <label for="product_category">Категория *</label>
                                    {% if form.category.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.category.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Магазин -->
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select class="form-select" id="product_store"
                                            name="{{ form.store.name }}" required>
                                        {% for value, label in form.store.field.choices %}
                                            <option value="{{ value }}"
                                                {% if not success_message and form.store.value == value %}selected{% endif %}>
                                                {{ label }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <label for="product_store">Магазин *</label>
                                    {% if form.store.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.store.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Фотография товара -->
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="product_image" class="form-label">Фотография товара</label>
                                    <div class="input-group">
                                        <input type="file" class="form-control" id="product_image"
                                               name="{{ form.image.name }}" accept="image/*">
                                        <label class="input-group-text" for="product_image">
                                            <i class="fas fa-upload"></i>
                                        </label>
                                    </div>
                                    {% if form.image.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.image.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <small class="form-text text-muted">Рекомендуемый размер: 800x600px, формат JPG/PNG</small>
                                </div>
                            </div>

                            <!-- Внешняя ссылка -->
                            <div class="col-12">
                                <div class="form-floating mb-3">
                                    <input type="url" class="form-control" id="product_external_url"
                                           name="{{ form.external_url.name }}"
                                           value="{% if not success_message %}{{ form.external_url.value|default:'' }}{% endif %}"
                                           placeholder="https://example.com">
                                    <label for="product_external_url">Ссылка на товар (необязательно)</label>
                                    {% if form.external_url.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.external_url.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Описание -->
                            <div class="col-12">
                                <div class="form-floating mb-3">
                                    <textarea class="form-control" id="product_description"
                                              name="{{ form.description.name }}"
                                              style="height: 150px">{% if not success_message %}{{ form.description.value|default:'' }}{% endif %}</textarea>
                                    <label for="product_description">Описание товара</label>
                                    {% if form.description.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.description.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Доступность -->
                            <div class="col-12">
                                <div class="form-check form-switch mb-4">
                                    <input type="checkbox" class="form-check-input" id="product_available"
                                           name="{{ form.available.name }}"
                                           {% if not success_message and form.available.value %}checked{% endif %}>
                                    <label class="form-check-label" for="product_available">
                                        Товар доступен для продажи
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid mt-2">
                            <button type="submit" class="btn btn-primary btn-lg py-3">
                                <i class="fas fa-save me-2"></i> Сохранить товар
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        border-radius: 15px;
        overflow: hidden;
    }

    .form-control, .form-select {
        border-radius: 10px;
        padding: 1rem;
        height: calc(3.5rem + 2px);
        border: 1px solid #dee2e6;
    }

    .form-floating>label {
        padding: 1rem;
        color: #6c757d;
    }

    .form-control:focus, .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    textarea.form-control {
        min-height: 150px;
        padding-top: 1.5rem;
    }

    .invalid-feedback {
        display: block;
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 0.25rem;
    }

    .form-check-input {
        width: 3em;
        height: 1.5em;
    }

    .input-group-text {
        border-radius: 0 10px 10px 0;
        background-color: #f8f9fa;
    }

    .alert-success {
        border-radius: 10px;
        background-color: #d1e7dd;
        border-color: #badbcc;
    }

    .btn-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .btn-primary:hover {
        background-color: #0b5ed7;
        border-color: #0a58ca;
    }
</style>

<script>
    // Очистка формы после успешного создания товара
    document.addEventListener('DOMContentLoaded', function() {
        {% if success_message %}
            // Очищаем все поля формы
            document.getElementById('product-form').reset();

            // Очищаем имя файла в загрузчике изображений
            const fileInput = document.getElementById('product_image');
            const fileLabel = fileInput.nextElementSibling;

            // Удаляем отображение имени файла, если есть
            const fileNameSpan = fileLabel.querySelector('.file-name');
            if (fileNameSpan) {
                fileNameSpan.remove();
            }

            // Восстанавливаем иконку загрузки
            fileLabel.querySelector('i').className = "fas fa-upload";
        {% endif %}

        // Показ имени выбранного файла
        document.getElementById('product_image').addEventListener('change', function(e) {
            var fileName = e.target.files[0]?.name || "Файл не выбран";
            var label = e.target.nextElementSibling;
            label.querySelector('i').className = "fas fa-file-image";

            // Удаляем предыдущее имя файла, если есть
            var existingFileName = label.querySelector('.file-name');
            if (existingFileName) {
                existingFileName.remove();
            }

            // Добавляем новое имя файла
            var fileNameSpan = document.createElement('span');
            fileNameSpan.className = 'file-name ms-2';
            fileNameSpan.textContent = fileName;
            label.appendChild(fileNameSpan);
        });

        // Валидация формы
        var forms = document.querySelectorAll('.needs-validation');

        Array.prototype.slice.call(forms).forEach(function(form) {
            form.addEventListener('submit', function(event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }

                form.classList.add('was-validated');
            }, false);

            // Добавляем валидацию при изменении полей
            form.querySelectorAll('input, select, textarea').forEach(function(field) {
                field.addEventListener('input', function() {
                    field.classList.remove('is-invalid', 'is-valid');

                    if (field.checkValidity()) {
                        field.classList.add('is-valid');
                    } else {
                        field.classList.add('is-valid');
                    }
                });
            });
        });
    });
</script>
{% endblock %}